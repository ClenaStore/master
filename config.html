<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Painel ADM - ConfiguraÃ§Ãµes</title>
  <style>
    body{
      margin:0;font-family:Arial,sans-serif;
      background:#f3f4f6;color:#111827;
    }
    main{padding:20px}
    h1{margin:0 0 20px 0}
    .grid{
      display:flex;flex-wrap:wrap;gap:20px;
    }
    .card{
      position:relative;
      width:140px;height:120px;background:#fff;border-radius:12px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.08);
      font-weight:bold;transition:.2s;
    }
    .card:hover{transform:translateY(-3px)}
    .badge{
      position:absolute;top:8px;right:12px;
      background:#dc2626;color:#fff;
      font-size:12px;font-weight:bold;
      border-radius:50%;padding:4px 7px;
      display:none;
    }
    iframe{
      position:fixed;top:0;left:0;width:100%;height:100%;
      border:none;z-index:1000;display:none;
      background:rgba(0,0,0,.7);
    }
  </style>
</head>
<body>
  <main>
    <h1>ConfiguraÃ§Ãµes</h1>
    <div class="grid">
      <div class="card" onclick="abrir('metas.html')">ðŸ“Š<br>Metas</div>

      <div class="card" onclick="abrir('cancelamentos.html')">
        ðŸ“‘<br>Cancelamentos
        <span class="badge" id="badgeCancel"></span>
      </div>
    </div>
  </main>

  <iframe id="popupFrame"></iframe>

  <script>
    const ENDPOINT="https://script.google.com/macros/s/AKfycbxJGO8cZCrBqNgrFkimXFTFyueugmJI3s3AlTe_NwnLxACaFAICgeOtlGXmBZxB9EI1ag/exec";

    function abrir(pag){
      const frame=document.getElementById("popupFrame");
      frame.src=pag;
      frame.style.display="block";
    }
    window.addEventListener("message",(ev)=>{
      if(ev.data==="fecharMetas"||ev.data==="fecharCancel"){
        document.getElementById("popupFrame").style.display="none";
        document.getElementById("popupFrame").src="";
        if(ev.data==="fecharCancel") carregarBadge(); // recarrega badge apÃ³s salvar
      }
    });

    async function carregarBadge(){
      try{
        const res=await fetch(ENDPOINT+"?acao=statuscancelamentos");
        const js=await res.json();
        let total=0;
        (js.companies||[]).forEach(c=>{
          if(c.pendentes) total+=c.pendentes.length;
        });
        const badge=document.getElementById("badgeCancel");
        if(total>0){
          badge.textContent=total;
          badge.style.display="block";
        }else{
          badge.style.display="none";
        }
      }catch(e){console.error("Erro badge:",e);}
    }

    carregarBadge();
  </script>
</body>
</html>
