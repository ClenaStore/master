<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Painel ADM</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#f5f7fa;display:flex;height:100vh}
    aside{width:220px;background:#1e40af;color:#fff;display:flex;flex-direction:column}
    aside h2{padding:20px 15px;font-size:18px;border-bottom:1px solid rgba(255,255,255,.2)}
    aside button{background:none;border:none;color:#fff;text-align:left;padding:15px;cursor:pointer;font-size:15px;width:100%}
    aside button:hover{background:rgba(255,255,255,.1)}
    main{flex:1;padding:20px;overflow:auto}
    h1{margin-bottom:15px;color:#1e3a8a}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:20px}
    
    /* Card quadrado pequeno */
    .card{
      background:#fff;
      width:120px;height:120px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:bold;
      color:#1e3a8a;
      transition:all .2s ease;
    }
    .card:hover{background:#f0f4ff;transform:scale(1.05)}

    /* POPUP */
    .popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .popup-content{background:#fff;padding:20px;border-radius:10px;max-width:800px;width:90%;max-height:90vh;overflow:auto;position:relative}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#1e40af;color:#fff}
    input{width:100%;padding:6px}
    button.confirmar{margin-top:10px;padding:10px 20px;background:#1e40af;color:#fff;border:none;border-radius:6px;cursor:pointer}
    button.confirmar:hover{background:#3749db}
    .fechar{float:right;cursor:pointer;color:#888;font-size:18px}
    .fechar:hover{color:#000}

    /* Spinner no bot√£o */
    .spinner {
      border:3px solid #f3f3f3;
      border-top:3px solid #fff;
      border-radius:50%;
      width:16px;
      height:16px;
      animation:spin 1s linear infinite;
      display:inline-block;
      vertical-align:middle;
      margin-left:8px;
    }
    @keyframes spin {
      0% { transform:rotate(0deg);}
      100% { transform:rotate(360deg);}
    }
    #msg { margin-top:10px; font-weight:bold; }
  </style>
</head>
<body>
  <!-- MENU LATERAL -->
  <aside>
    <h2>‚öôÔ∏è Configura√ß√µes</h2>
    <button onclick="abrirModulo('config')">Configura√ß√µes</button>
  </aside>

  <!-- CONTE√öDO PRINCIPAL -->
  <main>
    <h1>Painel ADM</h1>

    <!-- MODULO CONFIGURA√á√ïES -->
    <section id="config" class="modulo">
      <h2>Configura√ß√µes</h2>
      <div class="grid">
        <div class="card" onclick="abrirPopup()">üìä<br>Metas</div>
      </div>
    </section>
  </main>

  <!-- POPUP DE METAS -->
  <div class="popup" id="popupMetas">
    <div class="popup-content">
      <span class="fechar" onclick="fecharPopup()">‚úñ</span>
      <h2>Definir Metas</h2>
      <form id="formMetas">
        <table>
          <thead>
            <tr>
              <th>Empresa</th>
              <th>Meta Atual</th>
              <th>Nova Meta</th>
            </tr>
          </thead>
          <tbody id="tabelaMetas">
            <!-- preenchido dinamicamente -->
          </tbody>
        </table>
        <button type="submit" class="confirmar">Salvar Metas</button>
        <p id="msg"></p>
      </form>
    </div>
  </div>

  <script>
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzT-G7UruOY72-2xVbQpgHuHId5kcAoW2fdh-uTCZVI8UsCuewE8BVrGDIj8qlwunEl/exec"; // seu GAS publicado

    function abrirModulo(id){
      document.querySelectorAll(".modulo").forEach(sec=>sec.style.display="none");
      document.getElementById(id).style.display="block";
    }
    abrirModulo("config"); // abre por padr√£o

    function abrirPopup(){
      document.getElementById("popupMetas").style.display="flex";
      carregarMetas();
    }
    function fecharPopup(){
      document.getElementById("popupMetas").style.display="none";
    }

    // Fun√ß√£o para formatar em moeda
    function formatarMoeda(input){
      let valor = input.value.replace(/\D/g, "");
      if(valor === "") {
        input.value = "";
        return;
      }
      valor = (parseInt(valor) / 100).toFixed(2) + "";
      valor = valor.replace(".", ",");
      valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      input.value = "R$ " + valor;
    }

    // Converte de volta para n√∫mero
    function limparMoeda(valor){
      return parseFloat(valor.replace(/[R$\.\s]/g, "").replace(",", "."));
    }

    // Carregar metas atuais da planilha
    async function carregarMetas(){
      const res = await fetch(ENDPOINT+"?acao=listarMetas");
      const data = await res.json();
      const tbody = document.getElementById("tabelaMetas");
      tbody.innerHTML = "";
      data.forEach(row=>{
        tbody.innerHTML += `
          <tr>
            <td>${row.empresa}</td>
            <td>R$ ${Number(row.previsto).toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
            <td><input type="text" class="moeda" name="novaMeta" data-empresa="${row.empresa}" oninput="formatarMoeda(this)"></td>
          </tr>
        `;
      });
    }

    // Salvar novas metas
    document.getElementById("formMetas").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const btn = e.target.querySelector("button.confirmar");
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Salvando <span class="spinner"></span>';
      btn.disabled = true;
      document.getElementById("msg").innerText = "";

      const inputs = document.querySelectorAll("input[name='novaMeta']");
      let novas = [];
      inputs.forEach(i=>{
        if(i.value){
          novas.push({empresa:i.dataset.empresa,meta:limparMoeda(i.value)});
        }
      });

      try{
        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({acao:"atualizarMetas",dados:novas})
        });
        const resp = await res.json();
        document.getElementById("msg").style.color = resp.status === "ok" ? "green" : "red";
        document.getElementById("msg").innerText = resp.msg;
      } catch(e){
        document.getElementById("msg").style.color = "red";
        document.getElementById("msg").innerText = "Erro: " + e.message;
      }

      btn.innerHTML = originalText;
      btn.disabled = false;

      carregarMetas(); // atualiza tabela
    });
  </script>
</body>
</html>
