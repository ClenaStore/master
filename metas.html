<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Metas</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- MENU -->
  <aside>
    <h2 onclick="location.href='index.html'">‚ò∞ Menu</h2>
    <button class="ativo" onclick="location.href='metas.html'">üìä Metas</button>
    <button onclick="location.href='historico.html'">üìñ Hist√≥rico</button>
    <button onclick="location.href='config.html'">‚öôÔ∏è Configura√ß√µes</button>
  </aside>

  <!-- CONTE√öDO -->
  <main>
    <h1>Definir Metas</h1>
    <form id="formMetas">
      <table>
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Meta Atual</th>
            <th>Nova Meta</th>
          </tr>
        </thead>
        <tbody id="tabelaMetas">
          <!-- preenchido dinamicamente -->
        </tbody>
      </table>
      <button type="submit" class="confirmar">Salvar Metas</button>
      <p id="msg"></p>
    </form>
  </main>

  <script>
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbxgN5Vzz3jGFGA0EvVIj-okctlPI5mszLTDuy2N-Np2YiMR2dLSPx0yE_o8yM1p5Uu0/exec";

    function formatarMoeda(input){
      let valor = input.value.replace(/\D/g, "");
      if(valor === "") { input.value = ""; return; }
      valor = (parseInt(valor) / 100).toFixed(2) + "";
      valor = valor.replace(".", ",");
      valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      input.value = "R$ " + valor;
    }
    function limparMoeda(valor){
      return parseFloat(valor.replace(/[R$\.\s]/g, "").replace(",", "."));
    }

    async function carregarMetas(){
      try {
        const res = await fetch(ENDPOINT+"?acao=listarMetas");
        const data = await res.json();
        const tbody = document.getElementById("tabelaMetas");
        tbody.innerHTML = "";
        data.forEach(row=>{
          tbody.innerHTML += `
            <tr>
              <td>${row.empresa}</td>
              <td>R$ ${Number(row.previsto).toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
              <td><input type="text" name="novaMeta" data-empresa="${row.empresa}" oninput="formatarMoeda(this)"></td>
            </tr>
          `;
        });
      } catch (e) {
        document.getElementById("msg").style.color = "red";
        document.getElementById("msg").innerText = "Erro ao carregar";
      }
    }

    document.getElementById("formMetas").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const btn = e.target.querySelector("button.confirmar");
      btn.innerHTML = 'Salvando...';
      btn.disabled = true;
      document.getElementById("msg").innerText = "";

      const inputs = document.querySelectorAll("input[name='novaMeta']");
      let novas = [];
      inputs.forEach(i=>{
        if(i.value){
          novas.push({empresa:i.dataset.empresa,meta:limparMoeda(i.value)});
        }
      });

      try{
        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({acao:"atualizarMetas",dados:novas})
        });
        const resp = await res.json();
        document.getElementById("msg").style.color = resp.status === "ok" ? "green" : "red";
        document.getElementById("msg").innerText = resp.status === "ok" ? "Sucesso" : resp.msg;
      } catch(e){
        document.getElementById("msg").style.color = "red";
        document.getElementById("msg").innerText = "Erro: " + e.message;
      }

      btn.innerHTML = 'Salvar Metas';
      btn.disabled = false;

      carregarMetas();
    });

    carregarMetas(); // carrega na abertura
  </script>
</body>
</html>
