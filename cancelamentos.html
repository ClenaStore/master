<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Cancelamentos</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding:20px; }
    button { padding:10px 20px; background:#1e40af; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#3749db; }

    /* POPUP */
    .popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5);
             display:none; align-items:center; justify-content:center; z-index:1000; }
    .popup-content { background:#fff; padding:20px; border-radius:10px; max-width:800px; width:90%;
                     max-height:90vh; overflow:auto; position:relative; }
    .fechar { position:absolute; top:10px; right:15px; cursor:pointer; font-size:18px; color:#888; }
    .fechar:hover { color:#000; }

    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#1e40af; color:#fff; }

    input { width:100%; padding:6px; }
    .sucesso { color:green; margin-top:10px; }
    .erro { color:red; margin-top:10px; }
  </style>
</head>
<body>

  <button onclick="abrirPopup()">Gerenciar Cancelamentos</button>

  <!-- POPUP -->
  <div class="popup" id="popupCancel">
    <div class="popup-content">
      <span class="fechar" onclick="fecharPopup()">âœ–</span>
      <h2>Cancelamentos</h2>

      <table>
        <thead><tr><th>Data</th><th>Empresa</th><th>Valor</th></tr></thead>
        <tbody id="tbodyCancel"></tbody>
      </table>

      <h3 style="margin-top:20px;">Adicionar novo</h3>
      <table>
        <tr>
          <td><input type="date" id="novaData"></td>
          <td><input type="text" id="novaEmpresa" placeholder="Empresa"></td>
          <td><input type="number" step="0.01" id="novoValor" placeholder="Valor"></td>
        </tr>
      </table>
      <button onclick="salvarCancelamento()">Salvar</button>
      <div id="msg"></div>
    </div>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwWbaN_11cEl5cl2wIRxERIeNe1pTFeYetwroOhVHBHy1k8-vcNwBM8iCCGQzJpa0Iztg/exec";

/* abrir e fechar */
function abrirPopup(){ 
  document.getElementById("popupCancel").style.display="flex"; 
  carregarCancelamentos();
}
function fecharPopup(){ 
  document.getElementById("popupCancel").style.display="none"; 
}

/* carregar dados */
async function carregarCancelamentos(){
  const tbody=document.getElementById("tbodyCancel");
  tbody.innerHTML="<tr><td colspan=3>Carregando...</td></tr>";
  try{
    const res=await fetch(ENDPOINT+"?acao=listarcancelamentos");
    const js=await res.json();
    if(js.status!=="ok"){ tbody.innerHTML="<tr><td colspan=3 class='erro'>"+js.msg+"</td></tr>"; return; }
    if(js.dados.length===0){ tbody.innerHTML="<tr><td colspan=3>Nenhum registro</td></tr>"; return; }
    tbody.innerHTML="";
    js.dados.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.data}</td><td>${r.empresa}</td><td>R$ ${r.valor.toFixed(2).replace(".",",")}</td>`;
      tbody.appendChild(tr);
    });
  }catch(err){
    tbody.innerHTML="<tr><td colspan=3 class='erro'>Erro: "+err.message+"</td></tr>";
  }
}

/* salvar novo */
async function salvarCancelamento(){
  const msg=document.getElementById("msg");
  msg.textContent=""; msg.className="";
  const data=document.getElementById("novaData").value;
  const empresa=document.getElementById("novaEmpresa").value.trim();
  const valor=parseFloat(document.getElementById("novoValor").value);

  if(!data || !empresa || isNaN(valor) || valor<=0){
    msg.textContent="Preencha todos os campos corretamente."; msg.className="erro"; return;
  }

  try{
    const res=await fetch(ENDPOINT,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({acao:"registrarcancelamentos",linhas:[{data,empresa,valor}]})
    });
    const js=await res.json();
    if(js.status==="ok"){ 
      msg.textContent="Salvo com sucesso."; msg.className="sucesso"; 
      document.getElementById("novaData").value="";
      document.getElementById("novaEmpresa").value="";
      document.getElementById("novoValor").value="";
      carregarCancelamentos();
    } else {
      msg.textContent=js.msg; msg.className="erro";
    }
  }catch(err){
    msg.textContent="Erro: "+err.message; msg.className="erro";
  }
}
</script>

</body>
</html>
