<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cancelamentos</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .hidden { display:none; }
    .erro { color:red; text-align:center; padding:6px; }
  </style>
</head>
<body>

<!-- POPUP -->
<div class="popup" id="popupCancelamentos" style="display:flex">
  <div class="popup-content">
    <span class="fechar" onclick="fecharPopup()">&times;</span>
    <h2>Cancelamentos</h2>
    <h3>Dias pendentes</h3>
    <table id="tabelaPendentes">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <a href="#" id="toggleLancados" onclick="toggleLancados(event)">+ Ver lançados</a>

    <table id="tabelaLancados" class="hidden">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="confirmar" onclick="salvar()">Salvar</button>
    <div id="msg"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzy2ul5jlmfVOnT4gJ4XDyjuIEdwrOUfctue9YH5fMIVJ1D6H1YBDPNkEGBcuLCWcYxvA/exec"; // Ex: https://script.google.com/macros/s/AKfycbz.../exec

// Helpers
function formatarData(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function fecharPopup(){
  document.getElementById("popupCancelamentos").style.display = "none";
}
function toggleLancados(e){
  e.preventDefault();
  const tabela = document.getElementById("tabelaLancados");
  tabela.classList.toggle("hidden");
  document.getElementById("toggleLancados").textContent =
    tabela.classList.contains("hidden") ? "+ Ver lançados" : "- Ocultar lançados";
}

// Carregar dados ao abrir
document.addEventListener("DOMContentLoaded", carregarPendentes);

async function carregarPendentes(){
  const corpo = document.querySelector("#tabelaPendentes tbody");
  corpo.innerHTML = "<tr><td colspan=3>Carregando...</td></tr>";

  try{
    const resp = await fetch(`${API_URL}?acao=statusCancelamentos`);
    const data = await resp.json();
    corpo.innerHTML = "";

    if(!data.companies || !data.companies.length){
      corpo.innerHTML = "<tr><td colspan=3>Nenhum pendente</td></tr>";
      return;
    }

    data.companies.forEach(emp => {
      emp.pendentes.forEach(dt => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${formatarData(dt)}</td><td>${emp.empresa}</td><td>-</td>`;
        corpo.appendChild(tr);
      });
    });

  }catch(err){
    corpo.innerHTML = `<tr><td colspan=3 class='erro'>Erro: ${err.message}</td></tr>`;
  }
}

async function carregarLancados(){
  const corpo = document.querySelector("#tabelaLancados tbody");
  corpo.innerHTML = "<tr><td colspan=3>Carregando...</td></tr>";
  try{
    const resp = await fetch(`${API_URL}?acao=listarCancelamentos`);
    const data = await resp.json();
    corpo.innerHTML = "";

    if(!data.dados || !data.dados.length){
      corpo.innerHTML = "<tr><td colspan=3>Nenhum lançado</td></tr>";
      return;
    }

    data.dados.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${formatarData(r.data)}</td><td>${r.empresa}</td><td>${r.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>`;
      corpo.appendChild(tr);
    });

  }catch(err){
    corpo.innerHTML = `<tr><td colspan=3 class='erro'>Erro: ${err.message}</td></tr>`;
  }
}

function salvar(){
  document.getElementById("msg").textContent = "✔️ Salvando (demo)";
}

// Auto-carrega lançados quando expandir
document.getElementById("toggleLancados").addEventListener("click", ()=>{
  if(!document.getElementById("tabelaLancados").classList.contains("hidden")){
    carregarLancados();
  }
});
</script>

</body>
</html>
