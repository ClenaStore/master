<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cancelamentos</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .popup-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 600px;
      max-width: 95%;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .popup-content h2 {
      margin: 0 0 10px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background: #1e40af;
      color: white;
    }
    .btn {
      background: #1e40af;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
    }
    .link {
      color: #1e40af;
      cursor: pointer;
      font-weight: bold;
    }
    input.valor-input {
      width: 100px;
      padding: 3px;
      text-align: right;
    }
  </style>
</head>
<body>
<div class="popup" id="popup">
  <div class="popup-content">
    <h2>Cancelamentos</h2>
    <h4>Dias pendentes</h4>
    <table id="tblPendentes">
      <thead>
        <tr>
          <th>Data</th>
          <th>Empresa</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="link" id="toggleLancados">+ Ver lançados</div>

    <table id="tblLancados" style="display:none">
      <thead>
        <tr>
          <th>Data</th>
          <th>Empresa</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn" id="btnSalvar">Salvar</button>
  </div>
</div>

<script>
const URL_GAS = "https://script.google.com/macros/s/AKfycbwBBHddS441GKa4iVkfZ8QAEeRca55hwcvCZ03zI3L_AC7DmWpLwkmxOJXHdjwE654rJg/exec"; // <-- coloque seu endpoint

document.addEventListener("DOMContentLoaded", () => {
  carregarPendentes();
  document.getElementById("toggleLancados").onclick = toggleLancados;
  document.getElementById("btnSalvar").onclick = salvarPendentes;
});

function carregarPendentes() {
  fetch(`${URL_GAS}?acao=statusCancelamentos`)
    .then(r => r.json())
    .then(json => {
      if (json.status !== "ok") throw new Error(json.msg);
      const corpo = document.querySelector("#tblPendentes tbody");
      corpo.innerHTML = "";

      json.companies.forEach(emp => {
        emp.pendentes.forEach(data => {
          const tr = document.createElement("tr");
          const tdData = document.createElement("td");
          const tdEmp = document.createElement("td");
          const tdVal = document.createElement("td");

          // data formatada dd/mm/yyyy
          const d = new Date(data);
          tdData.textContent = d.toLocaleDateString("pt-BR");

          tdEmp.textContent = emp.empresa;

          // input de valor
          const inp = document.createElement("input");
          inp.type = "number";
          inp.min = "0";
          inp.step = "0.01";
          inp.className = "valor-input";
          inp.dataset.empresa = emp.empresa;
          inp.dataset.data = data;
          tdVal.appendChild(inp);

          tr.appendChild(tdData);
          tr.appendChild(tdEmp);
          tr.appendChild(tdVal);
          corpo.appendChild(tr);
        });
      });
    })
    .catch(err => {
      document.querySelector("#tblPendentes tbody").innerHTML =
        `<tr><td colspan="3" style="color:red">Erro: ${err.message}</td></tr>`;
    });
}

function toggleLancados() {
  const tbl = document.getElementById("tblLancados");
  if (tbl.style.display === "none") {
    tbl.style.display = "";
    document.getElementById("toggleLancados").textContent = "- Ocultar lançados";
    carregarLancados();
  } else {
    tbl.style.display = "none";
    document.getElementById("toggleLancados").textContent = "+ Ver lançados";
  }
}

function carregarLancados() {
  fetch(`${URL_GAS}?acao=listarCancelamentos`)
    .then(r => r.json())
    .then(json => {
      if (json.status !== "ok") throw new Error(json.msg);
      const corpo = document.querySelector("#tblLancados tbody");
      corpo.innerHTML = "";
      json.dados.forEach(reg => {
        const tr = document.createElement("tr");
        const tdData = document.createElement("td");
        const tdEmp = document.createElement("td");
        const tdVal = document.createElement("td");

        const d = new Date(reg.data);
        tdData.textContent = d.toLocaleDateString("pt-BR");
        tdEmp.textContent = reg.empresa;
        tdVal.textContent = (reg.valor != null && !isNaN(reg.valor))
          ? Number(reg.valor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})
          : "—";

        tr.appendChild(tdData);
        tr.appendChild(tdEmp);
        tr.appendChild(tdVal);
        corpo.appendChild(tr);
      });
    })
    .catch(err => {
      document.querySelector("#tblLancados tbody").innerHTML =
        `<tr><td colspan="3" style="color:red">Erro: ${err.message}</td></tr>`;
    });
}

function salvarPendentes() {
  const inputs = document.querySelectorAll("#tblPendentes input.valor-input");
  const linhas = [];
  inputs.forEach(inp => {
    if (inp.value) {
      linhas.push({
        empresa: inp.dataset.empresa,
        data: inp.dataset.data,
        valor: parseFloat(inp.value),
        item: "Itens diversos"
      });
    }
  });

  if (!linhas.length) {
    alert("Nenhum valor preenchido.");
    return;
  }

  fetch(URL_GAS, {
    method: "POST",
    body: JSON.stringify({ acao: "registrarCancelamentos", linhas }),
    headers: { "Content-Type": "application/json" }
  })
    .then(r => r.json())
    .then(json => {
      if (json.status !== "ok") throw new Error(json.msg);
      alert("Cancelamentos registrados com sucesso!");
      carregarPendentes();
    })
    .catch(err => alert("Erro ao salvar: " + err.message));
}
</script>
</body>
</html>
