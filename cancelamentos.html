<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Cancelamentos</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .hidden{display:none}
    .erro{color:#d00;text-align:center;padding:10px}
    .info{color:#334155;text-align:center;padding:8px}
    .muted{color:#64748b}
    .link{cursor:pointer;color:#4f46e5;font-weight:600;text-decoration:none}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body>

<!-- POPUP (abre direto nesta p√°gina) -->
<div class="popup" id="popupCancelamentos" style="display:flex">
  <div class="popup-content">
    <span class="fechar" onclick="fecharPopup()">‚úñ</span>
    <h2>Cancelamentos</h2>

    <h3>Dias pendentes</h3>
    <table id="tbPend">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="info">Carregando‚Ä¶</td></tr>
      </tbody>
    </table>

    <div style="margin:10px 0">
      <a id="btnToggleLanc" class="link" href="#" onclick="toggleLancados(event)">+ Ver lan√ßados</a>
    </div>

    <table id="tbLanc" class="hidden">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="info">‚Äî</td></tr>
      </tbody>
    </table>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>
</div>

<script>
  // üîó Cole aqui o URL do seu Web App (GAS publicado)
  const API_URL = "https://script.google.com/macros/s/AKfycbzy2ul5jlmfVOnT4gJ4XDyjuIEdwrOUfctue9YH5fMIVJ1D6H1YBDPNkEGBcuLCWcYxvA/exec";

  const elPend = document.querySelector('#tbPend tbody');
  const elLanc = document.querySelector('#tbLanc tbody');
  const elMsg  = document.getElementById('msg');
  const elBtnToggle = document.getElementById('btnToggleLanc');
  let lancadosCarregados = false;

  function fecharPopup(){
    document.getElementById('popupCancelamentos').style.display = 'none';
  }

  function formatBR(iso){
    if(!iso || typeof iso !== 'string' || !iso.includes('-')) return '';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  function formatCurrency(v){
    // trata null/undefined/string vazia/‚Äú0,00‚Äù
    if (v === null || v === undefined || v === '') return '‚Äî';
    const num = Number(v);
    if (!isFinite(num)) return '‚Äî';
    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  async function carregarPendentes(){
    elPend.innerHTML = `<tr><td colspan="3" class="info">Carregando‚Ä¶</td></tr>`;
    elMsg.textContent = '';

    try{
      const r = await fetch(`${API_URL}?acao=statusCancelamentos`, { cache: 'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const js = await r.json();

      elPend.innerHTML = '';
      const companies = Array.isArray(js?.companies) ? js.companies : [];

      if (companies.length === 0){
        elPend.innerHTML = `<tr><td colspan="3" class="info">Nenhum pendente</td></tr>`;
        return;
      }

      let totalLinhas = 0;
      companies.forEach(c => {
        const pend = Array.isArray(c.pendentes) ? c.pendentes : [];
        pend.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${formatBR(d)}</td>
            <td>${c.empresa || ''}</td>
            <td>‚Äî</td>`;
          elPend.appendChild(tr);
          totalLinhas++;
        });
      });

      if (totalLinhas === 0){
        elPend.innerHTML = `<tr><td colspan="3" class="info">Nenhum pendente</td></tr>`;
      }

    }catch(err){
      elPend.innerHTML = `<tr><td colspan="3" class="erro">Erro: ${err.message || err}</td></tr>`;
    }
  }

  function toggleLancados(ev){
    ev?.preventDefault?.();
    const table = document.getElementById('tbLanc');
    table.classList.toggle('hidden');
    const aberto = !table.classList.contains('hidden');
    elBtnToggle.textContent = aberto ? '‚àí Ocultar lan√ßados' : '+ Ver lan√ßados';
    if (aberto && !lancadosCarregados) carregarLancados();
  }

  async function carregarLancados(){
    elLanc.innerHTML = `<tr><td colspan="3" class="info">Carregando‚Ä¶</td></tr>`;
    elMsg.textContent = '';

    try{
      const r = await fetch(`${API_URL}?acao=listarCancelamentos`, { cache: 'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const js = await r.json();

      elLanc.innerHTML = '';
      const dados = Array.isArray(js?.dados) ? js.dados : [];

      if (dados.length === 0){
        elLanc.innerHTML = `<tr><td colspan="3" class="info">Nenhum lan√ßamento encontrado</td></tr>`;
        lancadosCarregados = true;
        return;
      }

      // Ordena por data asc (opcional)
      dados.sort((a,b) => (a.data||'').localeCompare(b.data||''));

      dados.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatBR(l.data)}</td>
          <td>${l.empresa || ''}</td>
          <td>${formatCurrency(l.valor)}</td>`;
        elLanc.appendChild(tr);
      });

      lancadosCarregados = true;

    }catch(err){
      elLanc.innerHTML = `<tr><td colspan="3" class="erro">Erro: ${err.message || err}</td></tr>`;
    }
  }

  // Carrega pendentes ao abrir
  document.addEventListener('DOMContentLoaded', carregarPendentes);
</script>

</body>
</html>
