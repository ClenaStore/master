<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Cancelamentos</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .popup-content{max-width:850px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:6px;text-align:center}
    th{background:#173ea5;color:#fff}
    .sucesso{color:green}
    .erro{color:red}
    .toggle{color:#2563eb;cursor:pointer;font-size:14px;display:block;margin:8px 0}
  </style>
</head>
<body>
  <div class="popup" style="display:flex">
    <div class="popup-content">
      <span class="fechar" onclick="fechar()">✖</span>
      <h2>Cancelamentos</h2>

      <h3>Pendentes</h3>
      <table>
        <thead><tr><th>Data</th><th>Empresa</th><th>Valor</th></tr></thead>
        <tbody id="tbodyPend"></tbody>
      </table>

      <span class="toggle" id="toggleLancados">+ Mostrar lançados</span>
      <div id="boxLancados" style="display:none">
        <h3>Lançados</h3>
        <table>
          <thead><tr><th>Data</th><th>Empresa</th><th>Valor</th></tr></thead>
          <tbody id="tbodyLanc"></tbody>
        </table>
      </div>

      <button id="btnSalvar">Salvar</button>
      <span id="msg"></span>
    </div>
  </div>

<script>
const ENDPOINT="https://script.google.com/macros/s/AKfycbwtwPTZbfhQZbAZhXODFceK2luU04OigZUT4wvNpFh5la1cgZT5R-y5hX-zWYCBFzpIRQ/exec";

function fechar(){
  window.parent.postMessage("fecharCancel","*");
}

// máscara moeda
function maskMoeda(el){
  let v=el.value.replace(/\D/g,"");
  if(!v){el.value="";return;}
  v=(parseInt(v,10)/100).toFixed(2).replace(".",",");
  v=v.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  el.value="R$ "+v;
}
function toNumber(s){return Number((s||"").replace(/[R$\s\.]/g,"").replace(",",".")||0);}
function formatBR(d){return d.split("-").reverse().join("/");}

// carregar pendentes + lançados
async function init(){
  const pend=await (await fetch(ENDPOINT+"?acao=statuscancelamentos")).json();
  const lanc=await (await fetch(ENDPOINT+"?acao=listarcancelamentos")).json();

  const tbPend=document.getElementById("tbodyPend");
  tbPend.innerHTML="";
  let temPend=false;
  (pend.companies||[]).forEach(c=>{
    (c.pendentes||[]).forEach(dt=>{
      temPend=true;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${formatBR(dt)}</td>
        <td>${c.empresa}</td>
        <td><input class="moeda" data-empresa="${c.empresa}" data-data="${dt}" placeholder="R$ 0,00"></td>`;
      tr.querySelector("input").addEventListener("input",ev=>maskMoeda(ev.target));
      tbPend.appendChild(tr);
    });
  });
  if(!temPend) tbPend.innerHTML=`<tr><td colspan="3">Sem pendências</td></tr>`;

  const tbLanc=document.getElementById("tbodyLanc");
  tbLanc.innerHTML="";
  (lanc.dados||[]).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${formatBR(r.data)}</td><td>${r.empresa}</td><td>R$ ${r.valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>`;
    tbLanc.appendChild(tr);
  });
}

document.getElementById("btnSalvar").onclick=async()=>{
  const msg=document.getElementById("msg");
  msg.textContent="";
  const linhas=[];
  document.querySelectorAll(".moeda").forEach(i=>{
    const v=toNumber(i.value);
    if(v>0) linhas.push({empresa:i.dataset.empresa,valor:v,data:i.dataset.data});
  });
  if(!linhas.length){msg.textContent="Preencha valores";msg.className="erro";return;}

  const r=await fetch(ENDPOINT,{
    method:"POST",headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({acao:"registrarcancelamentos",linhas})
  });
  const js=await r.json();
  if(js.status==="ok"){msg.textContent="Sucesso";msg.className="sucesso";init();}
  else{msg.textContent=js.msg;msg.className="erro";}
};

document.getElementById("toggleLancados").onclick=()=>{
  const box=document.getElementById("boxLancados");
  if(box.style.display==="none"){box.style.display="block";document.getElementById("toggleLancados").textContent="- Ocultar lançados";}
  else{box.style.display="none";document.getElementById("toggleLancados").textContent="+ Mostrar lançados";}
};

init();
</script>
</body>
</html>
