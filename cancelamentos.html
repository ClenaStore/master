<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Cancelamentos</title>
  <style>
    body{margin:0;font-family:Arial;background:#f3f4f6}
    .overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;
    }
    .popup{
      background:#fff;padding:20px;border-radius:8px;max-width:800px;width:90%;max-height:90%;
      overflow:auto;box-shadow:0 6px 20px rgba(0,0,0,.25)
    }
    .popup h2{margin:0 0 15px}
    .fechar{float:right;cursor:pointer;font-size:18px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:6px;text-align:center}
    th{background:#173ea5;color:#fff}
    .hidden{display:none}
    .btn{background:#173ea5;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
    .btn:disabled{background:#999}
    .link{color:#173ea5;cursor:pointer;font-size:14px;display:block;margin-top:8px}
    #msg{margin-left:10px;font-weight:bold}
    .sucesso{color:green}.erro{color:red}
  </style>
</head>
<body>
<div class="overlay">
  <div class="popup">
    <span class="fechar" onclick="window.location.href='config.html'">✖</span>
    <h2>Cancelamentos</h2>

    <table>
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody id="tbodyPend"></tbody>
    </table>

    <span id="toggleLancados" class="link" onclick="toggleLancados()">+ Mostrar lançados</span>

    <table id="tbLancados" class="hidden">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody id="tbodyLanc"></tbody>
    </table>

    <div style="margin-top:10px">
      <button id="btnSalvar" class="btn">Salvar</button>
      <span id="msg"></span>
    </div>
  </div>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzT5s59n8ymg3e8lptDNvMU8AIvlxm4czi5LLOikkttwRThb7HQrut_yxcPWYdzmEcV3g/exec";

// formata R$ para entrada
function maskMoeda(el){
  let v = el.value.replace(/\D/g,"");
  if(!v){ el.value=""; return; }
  v=(parseInt(v,10)/100).toFixed(2).replace(".",",");
  v=v.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  el.value="R$ "+v;
}
function toNumber(s){ return Number((s||"").replace(/[R$\s\.]/g,"").replace(",",".")||0); }
function fmtBR(d){ const p=d.split("-"); return p[2]+"/"+p[1]+"/"+p[0]; }

async function carregar(){
  const pendBody=document.getElementById("tbodyPend");
  const lancBody=document.getElementById("tbodyLanc");
  pendBody.innerHTML="<tr><td colspan=3>Carregando...</td></tr>";

  try{
    const [pendRes,lancRes] = await Promise.all([
      fetch(ENDPOINT+"?acao=statuscancelamentos").then(r=>r.json()),
      fetch(ENDPOINT+"?acao=listarcancelamentos").then(r=>r.json())
    ]);

    pendBody.innerHTML="";
    lancBody.innerHTML="";

    // pendentes
    (pendRes.companies||[]).forEach(c=>{
      c.pendentes.forEach(d=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${fmtBR(d)}</td>
                      <td>${c.empresa}</td>
                      <td><input data-empresa="${c.empresa}" data-data="${d}" class="moeda" placeholder="R$ 0,00"></td>`;
        tr.querySelector("input").addEventListener("input",ev=>maskMoeda(ev.target));
        pendBody.appendChild(tr);
      });
    });
    if(!pendBody.children.length) pendBody.innerHTML="<tr><td colspan=3>Sem pendências</td></tr>";

    // lançados
    (lancRes.dados||[]).forEach(l=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${fmtBR(l.data)}</td>
                    <td>${l.empresa}</td>
                    <td><input disabled value="R$ ${l.valor.toFixed(2).replace('.',',')}"></td>`;
      lancBody.appendChild(tr);
    });

  }catch(err){
    pendBody.innerHTML=`<tr><td colspan=3 style="color:red">Erro: ${err.message}</td></tr>`;
  }
}

function toggleLancados(){
  const tb=document.getElementById("tbLancados");
  const link=document.getElementById("toggleLancados");
  if(tb.classList.contains("hidden")){
    tb.classList.remove("hidden");
    link.textContent="- Ocultar lançados";
  }else{
    tb.classList.add("hidden");
    link.textContent="+ Mostrar lançados";
  }
}

document.getElementById("btnSalvar").onclick=async ()=>{
  const msg=document.getElementById("msg");
  msg.textContent="";
  const linhas=[];
  document.querySelectorAll(".moeda").forEach(i=>{
    const v=toNumber(i.value);
    if(v>0) linhas.push({empresa:i.dataset.empresa,valor:v,data:i.dataset.data});
  });
  if(!linhas.length){ msg.textContent="Preencha valores"; msg.className="erro"; return; }

  const r=await fetch(ENDPOINT,{
    method:"POST",headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({acao:"registrarcancelamentos",data:linhas[0].data,linhas})
  });
  const js=await r.json();
  if(js.status==="ok"){ msg.textContent="Sucesso"; msg.className="sucesso"; carregar(); }
  else{ msg.textContent=js.msg; msg.className="erro"; }
};

carregar();
</script>
</body>
</html>
