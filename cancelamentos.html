<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Cancelamentos</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .hidden{display:none}
    .erro{color:#d00;text-align:center;padding:10px}
    .info{color:#334155;text-align:center;padding:8px}
    .muted{color:#64748b}
    .link{cursor:pointer;color:#4f46e5;font-weight:600;text-decoration:none}
    .link:hover{text-decoration:underline}
    input.valor-edit{
      width: 120px;
      padding: 5px;
      text-align: right;
    }
  </style>
</head>
<body>

<!-- POPUP (abre direto nesta pÃ¡gina) -->
<div class="popup" id="popupCancelamentos" style="display:flex">
  <div class="popup-content">
    <span class="fechar" onclick="fecharPopup()">âœ–</span>
    <h2>Cancelamentos</h2>

    <h3>Dias pendentes</h3>
    <table id="tbPend">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="info">Carregandoâ€¦</td></tr>
      </tbody>
    </table>

    <div style="margin:10px 0">
      <a id="btnToggleLanc" class="link" href="#" onclick="toggleLancados(event)">+ Ver lanÃ§ados</a>
    </div>

    <table id="tbLanc" class="hidden">
      <thead>
        <tr><th>Data</th><th>Empresa</th><th>Valor</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="info">â€”</td></tr>
      </tbody>
    </table>

    <div style="margin-top:15px;text-align:center">
      <button onclick="salvarPendentes()" class="confirmar">Salvar</button>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>
</div>

<script>
  // ðŸ”— Cole aqui o URL do seu Web App (GAS publicado)
  const API_URL = "https://script.google.com/macros/s/AKfycbxuFf8_OoqNdN382EUcxDbbTeZkjfksyEKhLJATTPohVKO6pgzWS1n6vc1mFR7wWH7PCw/exec";

  const elPend = document.querySelector('#tbPend tbody');
  const elLanc = document.querySelector('#tbLanc tbody');
  const elMsg  = document.getElementById('msg');
  const elBtnToggle = document.getElementById('btnToggleLanc');
  let lancadosCarregados = false;

  function fecharPopup(){
    document.getElementById('popupCancelamentos').style.display = 'none';
  }

  function formatBR(iso){
    if(!iso || typeof iso !== 'string' || !iso.includes('-')) return '';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  function formatCurrency(v){
    if (v === null || v === undefined || v === '') return 'â€”';
    const num = Number(v);
    if (!isFinite(num)) return 'â€”';
    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function formatarMoeda(input) {
    let valor = input.value.replace(/\D/g, ""); 
    if (!valor) {
      input.value = "";
      return;
    }
    valor = (parseInt(valor, 10) / 100).toFixed(2); 
    input.value = new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(valor);
  }

  async function carregarPendentes(){
    elPend.innerHTML = `<tr><td colspan="3" class="info">Carregandoâ€¦</td></tr>`;
    elMsg.textContent = '';

    try{
      const r = await fetch(`${API_URL}?acao=statusCancelamentos`, { cache: 'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const js = await r.json();

      elPend.innerHTML = '';
      const companies = Array.isArray(js?.companies) ? js.companies : [];

      if (companies.length === 0){
        elPend.innerHTML = `<tr><td colspan="3" class="info">Nenhum pendente</td></tr>`;
        return;
      }

      let totalLinhas = 0;
      companies.forEach(c => {
        const pend = Array.isArray(c.pendentes) ? c.pendentes : [];
        pend.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${formatBR(d)}</td>
            <td>${c.empresa || ''}</td>
            <td><input type="text" class="valor-edit" data-empresa="${c.empresa}" data-data="${d}" oninput="formatarMoeda(this)" /></td>`;
          elPend.appendChild(tr);
          totalLinhas++;
        });
      });

      if (totalLinhas === 0){
        elPend.innerHTML = `<tr><td colspan="3" class="info">Nenhum pendente</td></tr>`;
      }

    }catch(err){
      elPend.innerHTML = `<tr><td colspan="3" class="erro">Erro: ${err.message || err}</td></tr>`;
    }
  }

  function toggleLancados(ev){
    ev?.preventDefault?.();
    const table = document.getElementById('tbLanc');
    table.classList.toggle('hidden');
    const aberto = !table.classList.contains('hidden');
    elBtnToggle.textContent = aberto ? 'âˆ’ Ocultar lanÃ§ados' : '+ Ver lanÃ§ados';
    if (aberto && !lancadosCarregados) carregarLancados();
  }

  async function carregarLancados(){
    elLanc.innerHTML = `<tr><td colspan="3" class="info">Carregandoâ€¦</td></tr>`;
    elMsg.textContent = '';

    try{
      const r = await fetch(`${API_URL}?acao=listarCancelamentos`, { cache: 'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const js = await r.json();

      elLanc.innerHTML = '';
      const dados = Array.isArray(js?.dados) ? js.dados : [];

      if (dados.length === 0){
        elLanc.innerHTML = `<tr><td colspan="3" class="info">Nenhum lanÃ§amento encontrado</td></tr>`;
        lancadosCarregados = true;
        return;
      }

      dados.sort((a,b) => (a.data||'').localeCompare(b.data||''));

      dados.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatBR(l.data)}</td>
          <td>${l.empresa || ''}</td>
          <td>${formatCurrency(l.valor)}</td>`;
        elLanc.appendChild(tr);
      });

      lancadosCarregados = true;

    }catch(err){
      elLanc.innerHTML = `<tr><td colspan="3" class="erro">Erro: ${err.message || err}</td></tr>`;
    }
  }

  async function salvarPendentes(){
    const inputs = document.querySelectorAll('#tbPend input.valor-edit');
    const linhas = [];

    inputs.forEach(inp => {
      if (inp.value) {
        let valorNum = inp.value.replace(/[^\d,]/g, "").replace(",", ".");
        valorNum = parseFloat(valorNum);
        if (!isNaN(valorNum)) {
          linhas.push({
            empresa: inp.dataset.empresa,
            data: inp.dataset.data,
            valor: valorNum,
            item: "Itens diversos"
          });
        }
      }
    });

    if (!linhas.length) {
      alert("Preencha pelo menos um valor para salvar.");
      return;
    }

    try{
      const r = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ acao: "registrarCancelamentos", linhas }),
        headers: { "Content-Type": "application/json" }
      });
      const js = await r.json();
      if(js.status !== 'ok') throw new Error(js.msg);
      alert("Registros salvos!");
      carregarPendentes();
      lancadosCarregados = false;
      carregarLancados();
    }catch(err){
      alert("Erro ao salvar: " + err.message);
    }
  }

  document.addEventListener('DOMContentLoaded', carregarPendentes);
</script>

</body>
</html>
